<!doctype html>
<html>
<head>
<title>rpg</title>
<meta http-equiv="content-type" content="text/html;charset=utf-8" />
</head>
<body>

<script type="text/javascript" src="js/gamepad.js"></script>
<script type="text/javascript" src="js/Update.js"></script>
<script type="text/javascript" src="js/MapCamera.js"></script>
<script type="text/javascript" src="js/MapView.js"></script>
<script type="text/javascript" src="js/CanvasMapView.js"></script>
<script type="text/javascript" src="js/MapModel.js"></script>
<script type="text/javascript" src="js/KeyWatcher.js"></script>
<script type="text/javascript" src="js/DialogView.js"></script>
<script type="text/javascript" src="js/World.js"></script>
<script type="text/javascript" src="js/game/SimpleInput.js"></script>
<script type="text/javascript" src="js/game/GameState.js"></script>



<script type="text/javascript">

var tileInfo = [];
tileInfo.push(
{
	type: "simple",
	passable: Passable.Air | Passable.Ground,
	coords:[ {x:32, y:32} ]
});

tileInfo.push(
{
	type: "simple",
	coords:[ {x:64, y:64} ]
});
tileInfo.push(
{
	type: "simple",
	coords:[ {x:64, y:96} ]
});
tileInfo.push(
{
	type: "simple",
	coords:[ {x:64, y:128} ]
});
tileInfo.push(
{
	type: "simple",
	coords:[ {x:32, y:128} ]
});
tileInfo.push(
{
	type: "simple",
	coords:[ {x:0, y:128} ]
});
tileInfo.push(
{
	type: "simple",
	coords:[ {x:0, y:96} ]
});
tileInfo.push(
{
	type: "simple",
	coords:[ {x:0, y:64} ]
});
tileInfo.push(
{
	type: "simple",
	coords:[ {x:32, y:64} ]
});
tileInfo.push(
{
	type: "simple",
	coords:[ {x:32, y:96} ]
});
tileInfo.push(
{
	type: "simple",
	coords:[ {x:64, y:32} ]
});
tileInfo.push(
{
	type: "simple",
	coords:[ {x:0, y:32} ]
});

tileInfo.push(
{
	type: "autotile12",
	passable: Passable.Air,
	indexes: [1,2,3,4,5,6,7,8,9,10,11]
});

function Map(w,h)
{
	var tiles = {};
	this.width = w;
	this.height = h;
	
	function makeTileKey(x,y) {
		return x + "," + y;
	}
	
	this.map = function(x,y)
	{
		if (tiles[makeTileKey(x,y)])
		{
			return tiles[makeTileKey(x,y)];
		}
		return 0;
	}
	
	this.setTile = function (x,y,tile)
	{
		tiles[makeTileKey(x,y)] = tile;
	}
	return this;
}

var mapInfo = new Map(100,100);

var charImg = new Image();
var tilesetImg = new Image();

charImg.src = "res/output.png";
charImg.onload = function ()
{
	tilesetImg.src = "res/tiles0.png";
	tilesetImg.onload = function()
	{
		startGame();
	}
}

function startGame()
{
	var input = new SimpleInput();
	var world = new World(tilesetImg, charImg, tileInfo, mapInfo);
	
	var map = new CanvasMapView(10, 10, 0, 640,480, world.getModel());
	var dialog = new DialogView(10,10,1,640,480,"res/midJQ.png");
	
	document.body.appendChild(dialog.getDiv());
	document.body.appendChild(map.getDiv());
	
	var gameState = new GameState(input, world, map);
	
	setInterval(function()
	{
		input.checkInputs();
		dialog.update();
		map.update();
		
	}, 16)
	
	var setTile =
	[
		Character.customAction(function(char)
		{
			var front = world.getPositionOf(char, 1);
			mapInfo.setTile(front.x, front.y, 12);
			world.rerenderWorld();
		})
	];
	
	var clearTile =
	[
		Character.customAction(function(char)
		{
			var front = world.getFrontOf(char, 1);
			mapInfo.setTile(front.x, front.y, 0);
			world.rerenderWorld();
		})
	];
	
	var fireballScript =
	[
		Character.setIsFlying,
		Character.setSlow(8),
		Character.setOnSomeone(),
		Character.walkForward,
		Character.walkForward,
		Character.walkForward,
		Character.walkForward,
		Character.walkForward,
		Character.walkForward,
		Character.walkForward,
		Character.walkForward,
		Character.die,
	];
	
	var heroScript =
	[
		Character.centerCamera,
		Character.assignDirectionalControl,
		Character.assignZ(setTile),
		Character.assignX(clearTile),
		Character.assignA([Character.interact]),
		Character.assignS([Character.spawnProjectileAtFront(5,fireballScript)])
	];
	
	var boyTalkedToScript =
	[
		Interaction.pauseInteractee,
		Interaction.faceInteractor,
		Script.showDialog(dialog),
		Script.speechDialog(dialog, ["にょろ〜ん"]),
		Script.hideDialog(dialog),
		Interaction.resumeInteractee
	];
	
	var boyScript =
	[
		Character.assignInteract(boyTalkedToScript),
		Character.setSlow(64),
		Character.walkUp,
		Character.walkUp,
		Character.walkDown,
		Character.walkDown,
		Script.repeat,
	];
	
	var girlScript =
	[
		Character.setSlow(64),
		Character.walkLeft,
		Character.walkLeft,
		Character.walkLeft,
		Character.walkLeft,
		Character.walkRight,
		Character.walkRight,
		Character.walkRight,
		Character.walkRight,
		Script.repeat,
	];
	
	var mainScript =
	[
		Script.addCharacter(0,0,0,heroScript),
		Script.addCharacter(1,5,5,girlScript),
		Script.addCharacter(3,3,3,boyScript),
		Script.showDialog(dialog),
		Script.speechDialog(dialog, [
			"Sie sind das Essen und we sind die Jager", 
			"HAH HAH HAH", 
			"HAHA"]),
		//Script.speechDialog(dialog, ["She was very nervous"]),
		Script.hideDialog(dialog),
	];
	
	gameState.runScript(mainScript);

}

</script>

</body>
</html>
